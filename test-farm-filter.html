<!DOCTYPE html>
<html>
<head>
    <title>Test Farm Filter</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .farm-filters {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-group label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .filter-group select,
        .filter-group input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .log {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .farm-list {
            margin-top: 20px;
        }
        .farm-record {
            border: 1px solid #eee;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .farm-record-type {
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 3px;
            color: white;
        }
        .farm-record-type.solo {
            background-color: #007bff;
        }
        .farm-record-type.team {
            background-color: #28a745;
        }
    </style>
</head>
<body>
    <h1>Test Farm Filter</h1>
    
    <div class="test-section">
        <h2>Farm Filters</h2>
        <div class="farm-filters">
            <div class="filter-group">
                <label>Filter by Type:</label>
                <select id="farm-type-filter" onchange="applyFarmFilters()">
                    <option value="all">All Farms</option>
                    <option value="solo">Solo Farms Only</option>
                    <option value="team">Team Farms Only</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>Search Player:</label>
                <input type="text" id="farm-player-search" placeholder="Enter player nickname..." oninput="applyFarmFilters()">
            </div>
            
            <div class="filter-group">
                <label>Search Location:</label>
                <input type="text" id="farm-location-search" placeholder="Enter location..." oninput="applyFarmFilters()">
            </div>
            
            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="clear-filters-btn" onclick="clearFarmFilters()">Clear Filters</button>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>Debug Buttons</h2>
        <button onclick="testFilterFunctionality()">Test Filter Functionality</button>
        <button onclick="loadSampleData()">Load Sample Data</button>
        <div id="log" class="log">Click buttons above to see logs...</div>
    </div>
    
    <div class="test-section">
        <h2>Farm Records</h2>
        <div id="farm-records-container" class="farm-list">
            <p>No farm records found.</p>
        </div>
    </div>

    <script>
        // Debug log function
        function debugLog(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }
        
        // Sample farm data
        const sampleFarms = [
            {
                id: '1',
                type: 'solo',
                date: '2023-05-15',
                time: 45,
                location: 'Dragon Valley',
                totalValue: 1500,
                items: [
                    { name: 'Dragon Scale', totalQuantity: 5, soldQuantity: 3, remainingQuantity: 2, estimatedValue: 200, soldPrice: 250 }
                ]
            },
            {
                id: '2',
                type: 'team',
                date: '2023-05-16',
                time: 60,
                location: 'Ice Cave',
                totalValue: 3000,
                members: [
                    { nickname: 'Player1', share: 50, amount: 1500, paid: true },
                    { nickname: 'Player2', share: 30, amount: 900, paid: false },
                    { nickname: 'Player3', share: 20, amount: 600, paid: true }
                ],
                items: [
                    { name: 'Ice Crystal', totalQuantity: 10, soldQuantity: 7, remainingQuantity: 3, estimatedValue: 150, soldPrice: 180 }
                ]
            },
            {
                id: '3',
                type: 'solo',
                date: '2023-05-17',
                time: 30,
                location: 'Forest',
                totalValue: 800,
                items: [
                    { name: 'Herb', totalQuantity: 20, soldQuantity: 15, remainingQuantity: 5, estimatedValue: 40, soldPrice: 50 }
                ]
            },
            {
                id: '4',
                type: 'team',
                date: '2023-05-18',
                time: 90,
                location: 'Desert',
                totalValue: 5000,
                members: [
                    { nickname: 'Player1', share: 40, amount: 2000, paid: true },
                    { nickname: 'Player4', share: 35, amount: 1750, paid: true },
                    { nickname: 'Player5', share: 25, amount: 1250, paid: false }
                ],
                items: [
                    { name: 'Gold Ore', totalQuantity: 25, soldQuantity: 20, remainingQuantity: 5, estimatedValue: 200, soldPrice: 220 }
                ]
            }
        ];
        
        // Format number with thousand separators
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }
        
        // Apply farm filters
        function applyFarmFilters() {
            debugLog('Applying farm filters...');
            
            // Get current farms (stored when loaded)
            const farms = window.currentFarms || [];
            debugLog('Current farms available for filtering: ' + farms.length);
            
            // Get filter values
            const typeFilter = document.getElementById('farm-type-filter').value;
            const playerSearch = document.getElementById('farm-player-search').value.toLowerCase();
            const locationSearch = document.getElementById('farm-location-search').value.toLowerCase();
            
            debugLog('Filter values - Type: ' + typeFilter + ' Player: ' + playerSearch + ' Location: ' + locationSearch);
            
            // Apply filters
            let filteredFarms = farms;
            
            // Filter by type
            if (typeFilter !== 'all') {
                debugLog('Applying type filter: ' + typeFilter);
                filteredFarms = filteredFarms.filter(farm => farm.type === typeFilter);
                debugLog('Farms after type filter: ' + filteredFarms.length);
            }
            
            // Filter by player (for team farms)
            if (playerSearch) {
                debugLog('Applying player filter: ' + playerSearch);
                filteredFarms = filteredFarms.filter(farm => {
                    if (farm.type === 'solo') {
                        return false; // Solo farms don't have players
                    }
                    return farm.members && farm.members.some(member => 
                        member.nickname && member.nickname.toLowerCase().includes(playerSearch)
                    );
                });
                debugLog('Farms after player filter: ' + filteredFarms.length);
            }
            
            // Filter by location
            if (locationSearch) {
                debugLog('Applying location filter: ' + locationSearch);
                filteredFarms = filteredFarms.filter(farm => 
                    farm.location && farm.location.toLowerCase().includes(locationSearch)
                );
                debugLog('Farms after location filter: ' + filteredFarms.length);
            }
            
            debugLog('Final filtered farms count: ' + filteredFarms.length);
            
            // Display filtered results
            displayFarmRecords(filteredFarms);
        }
        
        // Clear all filters
        function clearFarmFilters() {
            debugLog('Clearing all farm filters');
            document.getElementById('farm-type-filter').value = 'all';
            document.getElementById('farm-player-search').value = '';
            document.getElementById('farm-location-search').value = '';
            applyFarmFilters();
        }
        
        // Display farm records
        function displayFarmRecords(farms) {
            const container = document.getElementById('farm-records-container');
            
            debugLog('Displaying farm records: ' + farms.length);
            
            // Always set window.currentFarms when displaying records
            window.currentFarms = farms;
            
            if (farms.length === 0) {
                container.innerHTML = '<p>No farm records found for this date.</p>';
                return;
            }
            
            // Sort by date descending
            farms.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = farms.map(farm => `
                <div class="farm-record" data-farm-id="${farm.id}">
                    <div class="farm-record-header">
                        <div>
                            <span class="farm-record-type ${farm.type}">${farm.type === 'solo' ? 'üë§ Solo Farm' : 'üë• Team Farm'}</span>
                            <h4>${farm.location}</h4>
                            <p>${farm.date} ‚Ä¢ ${farm.time} minutes</p>
                        </div>
                        <div>
                            <h3>${formatNumber(farm.totalValue)}</h3>
                            <p>Total Value</p>
                        </div>
                    </div>
                    
                    ${farm.type === 'team' ? `
                        <div class="team-members-list">
                            ${farm.members.map(member => `
                                <div class="team-member-badge ${member.paid ? 'paid' : ''}">
                                    ${member.nickname} (${member.share}%) - ${formatNumber(member.amount)}
                                    <span class="payment-status ${member.paid ? 'paid' : 'unpaid'}">
                                        ${member.paid ? '‚úì Paid' : '‚è≥ Unpaid'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="farm-items-list">
                        <h5>Items:</h5>
                        ${farm.items.map(item => `
                            <div class="farm-item-row">
                                <span><strong>${item.name}</strong></span>
                                <span>Total: ${item.totalQuantity} | Sold: ${item.soldQuantity} | Remaining: ${item.remainingQuantity}</span>
                                <span>Est. Value: ${formatNumber(item.estimatedValue)} | Sold Price: ${formatNumber(item.soldPrice)}</span>
                                <span class="payment-status">
                                    üí∞ Total: ${formatNumber(item.totalSoldValue + item.totalRemainingValue)}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        // Test filter functionality
        function testFilterFunctionality() {
            debugLog('Testing filter functionality...');
            
            // Test getting filter values
            const typeFilter = document.getElementById('farm-type-filter');
            const playerSearch = document.getElementById('farm-player-search');
            const locationSearch = document.getElementById('farm-location-search');
            
            debugLog('Current filter values:');
            debugLog('- Type filter: ' + typeFilter.value);
            debugLog('- Player search: ' + playerSearch.value);
            debugLog('- Location search: ' + locationSearch.value);
            
            // Test applying filters
            applyFarmFilters();
        }
        
        // Load sample data
        function loadSampleData() {
            debugLog('Loading sample data...');
            window.currentFarms = sampleFarms;
            displayFarmRecords(sampleFarms);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Test page loaded');
        });
    </script>
</body>
</html>